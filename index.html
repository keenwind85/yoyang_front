<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ë‚´ ì£¼ë³€ ìš”ì–‘ì‹œì„¤ ì°¾ê¸°</title>
  <script src="//dapi.kakao.com/v2/maps/sdk.js?appkey=111c602d0e830ef83899bfab32a148e6&autoload=false&libraries=services"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@1.35.6/dist/umd/supabase.min.js"></script>
  <style>
    html, body { height: 100%; margin: 0; padding: 0; }
    body { background: #fafbfc; }
    #mobileOnly { display: none; }
    #mobileRoot { display: block; }
    @media (min-width: 601px) {
      #mobileOnly { display: flex; align-items: center; justify-content: center; height: 100vh; font-size: 1.2em; color: #e74c3c; background: #fff; }
      #mobileRoot { display: none; }
    }
    @media (max-width: 600px) {
      #mobileOnly { display: none; }
      #mobileRoot { display: block; }
      html, body { width: 100vw; height: 100vh; overflow-x: hidden; }
    }
    #topBar {
      position: fixed; top: 0; left: 0; width: 100vw; height: 52px;
      background: #fff; box-shadow: 0 2px 8px rgba(0,0,0,0.07);
      z-index: 2000; display: flex; align-items: center; padding: 0 8px;
    }
    #topBar .logo-area { flex: 0 0 auto; }
    #topBar .search-area {
      flex: 1 1 auto; display: flex; align-items: center; margin-left: 8px;
      width: 100%;
      gap: 0;
    }
    #topBar input[type="text"] {
      flex: 1 1 auto;
      min-width: 0;
      max-width: 100vw;
      padding: 8px 10px;
      border: 1px solid #ddd;
      border-radius: 6px 0 0 6px;
      font-size: 1em;
      outline: none;
      transition: border 0.2s;
      height: 38px;
      box-sizing: border-box;
    }
    #topBar input[type="text"]:focus { border-color: #e74c3c; }
    #topBar button {
      flex: 0 0 auto;
      height: 38px;
      padding: 0 16px;
      border: none;
      background: #e74c3c;
      color: #fff;
      border-radius: 0 6px 6px 0;
      font-size: 1em;
      cursor: pointer;
      transition: background 0.2s;
      margin-left: -1px;
      display: flex;
      align-items: center;
      justify-content: center;
      white-space: nowrap;
    }
    #topBar button:hover { background: #c0392b; }
    body { padding-top: 52px; }
    #filterBar {
      border-bottom:1px solid #f1f1f1; margin-top: 8px; padding-bottom: 0;
      display: flex; gap: 6px; align-items: center; background: #fff; z-index:1999; position:relative;
      overflow-x: auto;
      overflow-y: hidden;
      white-space: nowrap;
      -webkit-overflow-scrolling: touch;
      padding-left: 8px; padding-right: 8px;
      scrollbar-width: none;
      margin-bottom: 0;
    }
    #filterBar::-webkit-scrollbar { display: none; }
    .filter-btn {
      background:#f3f4f6; color:#444; border:none; border-radius:7px; padding:7px 16px; font-size:0.98em; font-weight:500; cursor:pointer; transition:background 0.18s, color 0.18s;
      white-space: nowrap;
      margin-right: 2px;
      flex: 0 0 auto;
      display: inline-block;
    }
    .filter-btn.selected {
      background:#e74c3c; color:#fff;
    }
    #map { width: 100vw; height: calc(100vh - 52px - 44px); margin-top: 0; }
    .facility-modal {
      position: fixed; left: 50%; top: 50%; transform: translate(-50%,-50%);
      background: #fff; border-radius: 12px; box-shadow: 0 2px 16px rgba(0,0,0,0.2);
      min-width: 80vw; max-width: 96vw; z-index: 1000; padding: 18px 10px;
      display: none; flex-direction: column; gap: 10px;
    }
    .facility-modal.active { display: flex; }
    .modal-close { position: absolute; right: 12px; top: 8px; font-size: 20px; cursor: pointer; }
    .modal-title { font-size: 1.1em; font-weight: bold; margin-bottom: 6px; }
    .modal-section { margin-bottom: 4px; font-size: 0.98em; }
    .modal-label { color: #888; font-size: 0.95em; margin-right: 4px; }
    .modal-value { font-weight: 500; }
    .modal-staff { display: flex; flex-wrap: wrap; gap: 6px; }
    .modal-bg { position: fixed; left:0; top:0; width:100vw; height:100vh; background:rgba(0,0,0,0.18); z-index:999; display:none; }
    .modal-bg.active { display:block; }
    #kakaoPlaceThumb { max-width:90vw; border-radius:10px; display:none; margin-top:16px; }
    #searchResults {
      position:absolute; left:0; right:0; top:40px; background:#fff; border:1px solid #ddd; border-radius:0 0 8px 8px; box-shadow:0 4px 16px rgba(0,0,0,0.07); z-index:3000; display:none; max-height:180px; overflow-y:auto; font-size:0.98em;
    }
    .search-result-item { padding:10px 14px; cursor:pointer; border-bottom:1px solid #f1f1f1; }
    .search-result-item:last-child { border-bottom:none; }
    @media (max-width: 400px) {
      #topBar { height: 46px; padding: 0 6px; }
      #topBar input[type="text"] { font-size: 0.95em; }
      #topBar button { font-size: 0.95em; padding: 6px 10px; }
      #filterBar { gap: 3px; }
      .filter-btn { padding: 5px 7px; font-size: 0.93em; }
      .facility-modal { min-width: 96vw; padding: 10px 2px; }
    }
    #radiusControl {
      position: fixed;
      left: 50%;
      bottom: 18px;
      transform: translateX(-50%);
      z-index: 2100;
      background: rgba(255,255,255,0.95);
      border-radius: 18px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      padding: 6px 10px;
      display: flex;
      gap: 6px;
      align-items: center;
      font-size: 0.98em;
    }
    .radius-btn {
      background: #f3f4f6;
      color: #444;
      border: none;
      border-radius: 12px;
      padding: 6px 14px;
      font-size: 1em;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.18s, color 0.18s;
    }
    .radius-btn.selected {
      background: #e74c3c;
      color: #fff;
    }
  </style>
</head>
<body>
  <div id="mobileOnly">ëª¨ë°”ì¼ í™˜ê²½ì—ì„œë§Œ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.</div>
  <div id="mobileRoot">
    <button id="getLocationBtn" style="
      display:block; margin:18px auto 0 auto; background:#2563eb; color:#fff; font-size:1.08rem; font-weight:600;
      border:none; border-radius:8px; padding:12px 32px; cursor:pointer; box-shadow:0 2px 8px rgba(0,0,0,0.07);">
      <span style="font-size:1.2em; vertical-align:middle;">ğŸ“</span> ë‚´ ìœ„ì¹˜ë¡œ ì°¾ê¸°
    </button>
    <div id="topBar">
      <div class="logo-area">
        <img src="/logo.png" alt="ë¡œê³ " style="height:28px;vertical-align:middle;" />
      </div>
      <div class="search-area">
        <input type="text" id="searchInput" placeholder="ì‹œì„¤ëª…, ì£¼ì†Œ ë“± ê²€ìƒ‰" autocomplete="off" />
        <button id="searchBtn">ê²€ìƒ‰</button>
        <div id="searchResults"></div>
      </div>
    </div>
    <div id="filterBar">
      <button class="filter-btn" data-type="all">ì „ì²´</button>
      <button class="filter-btn" data-type="A01,A02,A03,A04,A05,AAA">ë…¸ì¸ìš”ì–‘ì‹œì„¤</button>
      <button class="filter-btn" data-type="B01,C01">ë°©ë¬¸ìš”ì–‘</button>
      <button class="filter-btn" data-type="B02,C02">ë°©ë¬¸ëª©ìš•</button>
      <button class="filter-btn" data-type="B03,C03,B04,C04">ì£¼ì•¼ê°„ë³´í˜¸</button>
      <button class="filter-btn" data-type="B05,C05">ë°©ë¬¸ê°„í˜¸</button>
      <button class="filter-btn" data-type="C06">ë³µì§€ìš©êµ¬</button>
    </div>
    <div id="map"></div>
    <div id="radiusControl">
      <button class="radius-btn" data-radius="1000">1km</button>
      <button class="radius-btn" data-radius="3000">3km</button>
      <button class="radius-btn" data-radius="5000">5km</button>
      <button class="radius-btn" data-radius="7000">7km</button>
      <button class="radius-btn" data-radius="10000">10km</button>
    </div>
    <div class="modal-bg" id="modalBg"></div>
    <div class="facility-modal" id="facilityModal">
      <span class="modal-close" id="modalClose">&times;</span>
      <div class="modal-title" id="modalTitle"></div>
      <div class="modal-section"><span class="modal-label">ì„¤ë¦½ ì—°ì°¨:</span><span class="modal-value" id="modalYear"></span></div>
      <div class="modal-section"><span class="modal-label">ì‹œì„¤ ì¢…ë¥˜:</span><span class="modal-value" id="modalType"></span></div>
      <div class="modal-section modal-staff" id="modalStaff"></div>
      <div class="modal-section"><span class="modal-label">êµí†µ ì •ë³´:</span><span class="modal-value" id="modalTransport"></span></div>
      <div class="modal-section"><span class="modal-label">ì£¼ì°¨ ì •ë³´:</span><span class="modal-value" id="modalParking"></span></div>
    </div>
    <img id="kakaoPlaceThumb" alt="ì‹œì„¤ ëŒ€í‘œ ì´ë¯¸ì§€" />
  </div>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      kakao.maps.load(async function() {
        let currentFilterType = 'all';
        let currentRadius = 1000; // ê¸°ë³¸ê°’ 1km
        let currentUserLat = null;
        let currentUserLng = null;

        const supabase = window.supabase.createClient(
          'https://ecryblreqspjhmfpyjdn.supabase.co',
          'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVjcnlibHJlcXNwamhtZnB5amRuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDM5ODgwMTcsImV4cCI6MjA1OTU2NDAxN30.6W-be268DsgQIbgJVk6PBzc-odeRO-cLFOzn7CRkgAw'
        );

        // ì§€ë„ ë ˆë²¨ì— ë”°ë¼ ë°˜ê²½(m) ë°˜í™˜
        function getRadiusByLevel(level) {
          switch (level) {
            case 1: return 1000;   // 1km
            case 2: return 2000;   // 2km
            case 3: return 3000;   // 3km
            case 4: return 5000;   // 5km
            case 5: return 7000;   // 7km
            case 6: return 10000;  // 10km
            case 7: return 15000;  // 15km
            default: return 3000;  // ê¸°ë³¸ê°’
          }
        }

        // ì§€ë„, ë§ˆì»¤, ì˜¤ë²„ë ˆì´ ë“± ë³€ìˆ˜ ì„ ì–¸
        let map = null;
        let userMarker, userPulse, userCircle, userCircleAnim;
        let markers = [];
        let overlays = [];
        let watchId = null;
        let mapMoveListenerAdded = false;

        // ë°˜ë“œì‹œ ì´ ì•ˆì— renderFacilities í•¨ìˆ˜ë¥¼ ì„ ì–¸!
        async function renderFacilities(userLat, userLng, radius = currentRadius, filterType = currentFilterType) {
          console.log('renderFacilities í˜¸ì¶œ! filterType:', filterType);
          markers.forEach(m => m.setMap(null));
          markers = [];
          overlays.forEach(o => o.setMap(null));
          overlays = [];
          // facilities_with_geojsonì—ì„œ ë°˜ê²½ ë‚´ ì‹œì„¤ ì •ë³´ë§Œ ì¡°íšŒ
          const { data: facilities, error } = await supabase
            .rpc('get_facilities_within_radius', {
              lat: userLat,   // ìœ„ë„
              lng: userLng,   // ê²½ë„
              radius: radius
            });
          console.log('Supabase RPC íŒŒë¼ë¯¸í„°:', { lat: userLat, lng: userLng, radius: radius });
          console.log('Supabase RPC ê²°ê³¼ data:', facilities);
          console.log('Supabase RPC error:', error);
          if (error || !facilities || facilities.length === 0) {
            console.log('ì‹œì„¤ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
            return;
          }
          // í•„í„° íƒ€ì… ì„¸íŠ¸ ì¤€ë¹„
          let typeSet = null;
          if (filterType && filterType !== 'all') {
            typeSet = new Set(filterType.split(','));
          }
          console.log('renderFacilities filterType:', filterType, 'typeSet:', typeSet);
          for (const fac of facilities) {
            const typeCode = fac.admin_type_code;
            console.log('fac.id:', fac.id, 'typeCode:', typeCode, 'í•„í„°:', typeSet);
            if (!typeCode) continue;
            if (typeSet && !typeSet.has(typeCode)) continue;
            let lng, lat;
            if (fac.geojson) {
              try {
                const geo = JSON.parse(fac.geojson);
                [lng, lat] = geo.coordinates;
              } catch (e) {
                console.log('GeoJSON íŒŒì‹± ì‹¤íŒ¨:', fac.geojson);
                continue;
              }
            } else {
              console.log('ì¢Œí‘œ ì—†ìŒ:', fac);
              continue;
            }
            console.log('ì‹œì„¤ëª…:', fac.admin_name, 'lat:', lat, 'lng:', lng);
            if (isNaN(lat) || isNaN(lng)) {
              console.log('ì¢Œí‘œ NaN:', fac);
              continue;
            }
            const dist = getDistance(userLat, userLng, lat, lng);
            console.log('ê±°ë¦¬:', dist);
            // if (dist > radius) continue;
            const markerImage = new kakao.maps.MarkerImage(
              'assets/marker_carehome.svg',
              new kakao.maps.Size(40, 40),
              { offset: new kakao.maps.Point(20, 40) }
            );
            const marker = new kakao.maps.Marker({
              position: new kakao.maps.LatLng(lat, lng),
              map: map,
              image: markerImage,
              title: fac.admin_name
            });
            marker.facility = fac;
            kakao.maps.event.addListener(marker, 'click', () => {
              window.location.href = `facility-detail.html?id=${encodeURIComponent(fac.id)}`;
            });
            markers.push(marker);
            // === ì‹œì„¤ëª… ì»¤ìŠ¤í…€ ì˜¤ë²„ë ˆì´ ì¶”ê°€ ===
            const overlayContent = `
              <div class="facility-name-overlay" data-id="${fac.id}" style="
                background:rgba(255,255,255,0.95);
                border-radius:6px;
                padding:2px 8px;
                font-size:14px;
                color:#222;
                box-shadow:0 2px 6px rgba(0,0,0,0.07);
                border:1px solid #eee;
                margin-top:4px;
                white-space:nowrap;
                cursor:pointer;
                pointer-events:auto;
                user-select:none;
                ">
                ${fac.admin_name}
              </div>
            `;
            const nameOverlay = new kakao.maps.CustomOverlay({
              position: new kakao.maps.LatLng(lat, lng),
              content: overlayContent,
              yAnchor: -0.2 // ë§ˆì»¤ ì•„ë˜ì— ìœ„ì¹˜í•˜ë„ë¡ ì¡°ì •
            });
            nameOverlay.setMap(map);
            overlays.push(nameOverlay);
            // ì˜¤ë²„ë ˆì´ í´ë¦­ ì´ë²¤íŠ¸(ë™ì  DOMì´ë¯€ë¡œ setTimeoutìœ¼ë¡œ ë³´ì¥)
            setTimeout(() => {
              const overlayDiv = document.querySelector(`.facility-name-overlay[data-id='${fac.id}']`);
              if (overlayDiv) {
                overlayDiv.onclick = (e) => {
                  window.location.href = `facility-detail.html?id=${encodeURIComponent(fac.id)}`;
                  e.stopPropagation();
                };
              }
            }, 0);
          }
        }

        // ì§€ë„ ì´ˆê¸°í™”
        function showMap(lat, lng, useTracking = true) {
          const container = document.getElementById('map');
          if (!map) {
            map = new kakao.maps.Map(container, { center: new kakao.maps.LatLng(lat, lng), level: 5 });
            if (!mapMoveListenerAdded) {
              addMapMoveListener();
              mapMoveListenerAdded = true;
            }
          } else {
            map.setCenter(new kakao.maps.LatLng(lat, lng));
          }
          // ì§€ë„ ìƒˆë¡œ ìƒì„± ì‹œ ë§ˆì»¤/ì• ë‹ˆë©”ì´ì…˜ ê´€ë ¨ ë³€ìˆ˜ ëª¨ë‘ ì´ˆê¸°í™”
          if (userPulse && userPulse.parentNode) userPulse.parentNode.removeChild(userPulse);
          userPulse = null;
          userCircle = null;
          userCircleAnim = null;
          if (useTracking) startLocationTracking();
        }
        // ë‚´ ìœ„ì¹˜ ì‹¤ì‹œê°„ ì¶”ì 
        function startLocationTracking() {
          if (watchId) navigator.geolocation.clearWatch(watchId);
          watchId = navigator.geolocation.watchPosition(
            pos => {
              currentUserLat = pos.coords.latitude;
              currentUserLng = pos.coords.longitude;
              updateUserLocation(currentUserLat, currentUserLng);
            },
            err => {
              console.error('ìœ„ì¹˜ ì¶”ì  ì‹¤íŒ¨:', err);
            },
            { enableHighAccuracy: true, maximumAge: 1000, timeout: 10000 }
          );
        }
        // ë‚´ ìœ„ì¹˜ ì• ë‹ˆë©”ì´ì…˜/ì› ìœ„ì¹˜ ê°±ì‹  (kakao ë§ˆì»¤ ì—†ì´)
        function updateUserLocation(lat, lng) {
          currentUserLat = lat;
          currentUserLng = lng;
          if (!map) return;
          // userPulse(ë¹¨ê°„ ì›í˜• ì )
          const mapContainer = document.getElementById('map');
          if (!userPulse) {
            userPulse = document.createElement('div');
            userPulse.style.position = 'absolute';
            userPulse.style.width = '32px';
            userPulse.style.height = '32px';
            userPulse.style.pointerEvents = 'none';
            userPulse.style.zIndex = '3000';
            userPulse.innerHTML = '<div id="pulseDot" style="width:16px;height:16px;background:#e74c3c;border-radius:50%;position:absolute;left:8px;top:8px;box-shadow:0 0 8px #e74c3c88;"></div>';
            mapContainer.appendChild(userPulse);
            let scale = 1, growing = true;
            function animatePulse() {
              scale += (growing ? 0.03 : -0.03);
              if (scale > 1.4) growing = false;
              if (scale < 1.0) growing = true;
              userPulse.firstChild.style.transform = `scale(${scale})`;
              requestAnimationFrame(animatePulse);
            }
            animatePulse();
          }
          // ìœ„ì¹˜ ê°±ì‹ 
          const proj = map.getProjection();
          const myPoint = proj.pointFromCoords(new kakao.maps.LatLng(lat, lng));
          const center = map.getCenter();
          const centerPoint = proj.pointFromCoords(center);
          const mapWidth = mapContainer.offsetWidth;
          const mapHeight = mapContainer.offsetHeight;
          // ë‚´ ìœ„ì¹˜ì˜ map ì»¨í…Œì´ë„ˆ ë‚´ë¶€ ì¢Œí‘œ ê³„ì‚°
          const x = (myPoint.x - centerPoint.x) + mapWidth / 2 - 16;
          const y = (myPoint.y - centerPoint.y) + mapHeight / 2 - 16;
          userPulse.style.left = x + 'px';
          userPulse.style.top = y + 'px';
          // ë°˜ê²½ ì›
          const radius = getRadiusByLevel(map.getLevel());
          if (!userCircle) {
            userCircle = new kakao.maps.Circle({
              center: new kakao.maps.LatLng(lat, lng),
              radius: radius,
              strokeWeight: 0,
              strokeColor: '#e74c3c',
              strokeOpacity: 0.2,
              fillColor: '#e74c3c',
              fillOpacity: 0.15,
              map: map
            });
          } else {
            userCircle.setPosition(new kakao.maps.LatLng(lat, lng));
            userCircle.setRadius(radius);
          }
          // í¼ì§€ëŠ” ì• ë‹ˆë©”ì´ì…˜ ì›
          if (!userCircleAnim) {
            userCircleAnim = new kakao.maps.Circle({
              center: new kakao.maps.LatLng(lat, lng),
              radius: radius,
              strokeWeight: 0,
              fillColor: '#e74c3c',
              fillOpacity: 0.08,
              map: map
            });
            let animR = radius;
            function animateCircle() {
              animR += 2;
              if (animR > radius * 1.7) animR = radius;
              userCircleAnim.setRadius(animR);
              userCircleAnim.setPosition(new kakao.maps.LatLng(lat, lng));
              requestAnimationFrame(animateCircle);
            }
            animateCircle();
          } else {
            userCircleAnim.setPosition(new kakao.maps.LatLng(lat, lng));
            userCircleAnim.setRadius(radius);
          }
        }
        // ì§€ë„ ì´ë™/í™•ëŒ€/ì¶•ì†Œ ì‹œ ë‚´ ìœ„ì¹˜ ì• ë‹ˆë©”ì´ì…˜ ìœ„ì¹˜ ì¬ì¡°ì •
        function addMapMoveListener() {
          kakao.maps.event.addListener(map, 'zoom_changed', function() {
            if (currentUserLat !== null && currentUserLng !== null) {
              const radius = getRadiusByLevel(map.getLevel());
              renderFacilities(currentUserLat, currentUserLng, radius, currentFilterType);
            }
          });
          kakao.maps.event.addListener(map, 'center_changed', function() {
            if (currentUserLat !== null && currentUserLng !== null) {
              updateUserLocation(currentUserLat, currentUserLng);
            }
          });
        }
        // ë‚´ ìœ„ì¹˜ë¡œ ì°¾ê¸° ë²„íŠ¼ í´ë¦­ ì‹œ ìœ„ì¹˜ ìš”ì²­
        async function getUserLocation() {
          return new Promise((resolve, reject) => {
            if (!navigator.geolocation) {
              reject(new Error('Geolocation not supported'));
              return;
            }
            navigator.geolocation.getCurrentPosition(
              pos => resolve({ lat: pos.coords.latitude, lng: pos.coords.longitude }),
              err => {
                reject(err);
              },
              { enableHighAccuracy: true, timeout: 10000, maximumAge: 1000 }
            );
          });
        }
        document.getElementById('getLocationBtn').onclick = async function() {
          try {
            const loc = await getUserLocation();
            showMap(loc.lat, loc.lng, true);
            updateUserLocation(loc.lat, loc.lng);
          } catch (e) {
            alert('ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\n' +
              (e && e.code !== undefined
                ? `ì—ëŸ¬ ì½”ë“œ: ${e.code}\në©”ì‹œì§€: ${e.message}`
                : e && e.message
                  ? e.message
                  : 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
            console.error('Geolocation error:', e);
            handleLocationError();
          }
        };
        function handleLocationError() {
          alert('ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê¸°ë³¸ ìœ„ì¹˜(ì„œìš¸ì‹œì²­)ë¡œ ì´ë™í•©ë‹ˆë‹¤.');
          const defaultLat = 37.5665;
          const defaultLng = 126.9780;
          showMap(defaultLat, defaultLng, false); // ìœ„ì¹˜ ì¶”ì  ë¹„í™œì„±í™”
          updateUserLocation(defaultLat, defaultLng);
          renderFacilities(defaultLat, defaultLng, getRadiusByLevel(map.getLevel()), currentFilterType);
        }

        // ì‹œì„¤ ì¢…ë¥˜ ë³€í™˜
        function convertType(code) {
          if (["A01","A02","A03","A04","A05","AAA"].includes(code)) return "ë…¸ì¸ìš”ì–‘ì‹œì„¤";
          if (["B01","C01"].includes(code)) return "ë°©ë¬¸ìš”ì–‘";
          if (["B02","C02"].includes(code)) return "ë°©ë¬¸ëª©ìš•";
          if (["B03","C03","B04","C04"].includes(code)) return "ì£¼ì•¼ê°„ë³´í˜¸";
          if (["B05","C05"].includes(code)) return "ë°©ë¬¸ê°„í˜¸";
          if (code === "C06") return "ë³µì§€ìš©êµ¬";
          return code;
        }

        // ê±°ë¦¬ ê³„ì‚° í•¨ìˆ˜ (Haversine)
        function getDistance(lat1, lng1, lat2, lng2) {
          const R = 6371000;
          const toRad = x => x * Math.PI / 180;
          const dLat = toRad(lat2-lat1);
          const dLng = toRad(lng2-lng1);
          const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLng/2)**2;
          return 2 * R * Math.asin(Math.sqrt(a));
        }

        // ì‹œì„¤ ìƒì„¸ ì •ë³´ ëª¨ë‹¬ í‘œì‹œ
        async function showFacilityModal(fac) {
          document.getElementById('modalTitle').textContent = fac.admin_name;
          // ì„¤ë¦½ ì—°ì°¨
          let year = '';
          if (fac.install_date && fac.install_date.length >= 4) {
            const y = fac.install_date.slice(0,4);
            const now = new Date().getFullYear();
            year = `${y}ë…„ (${now-parseInt(y)+1}ë…„ì°¨)`;
          }
          document.getElementById('modalYear').textContent = year;
          // ì‹œì„¤ ì¢…ë¥˜
          document.getElementById('modalType').textContent = convertType(fac.admin_type_code);
          // ì§ì› ì •ë³´
          const { data: staff } = await supabase.from('staff_status').select('*').eq('facility_id', fac.id);
          let staffStrs = [];
          if (staff && staff.length > 0) {
            const s = staff[0];
            if (parseInt(s.social_worker) > 0) staffStrs.push(`ì‚¬íšŒë³µì§€ì‚¬ ${s.social_worker}ëª…`);
            const doctor = (parseInt(s.doctor_regular)||0) + (parseInt(s.doctor_parttime)||0);
            if (doctor > 0) staffStrs.push(`ì˜ì‚¬ ${doctor}ëª…`);
            const nurse = (parseInt(s.nurse)||0) + (parseInt(s.nurse_aide)||0);
            if (nurse > 0) staffStrs.push(`ê°„í˜¸ì‚¬ ${nurse}ëª…`);
            const caregiver = (parseInt(s.caregiver_level1)||0) + (parseInt(s.caregiver_level2)||0);
            if (caregiver > 0) staffStrs.push(`ìš”ì–‘ë³´í˜¸ì‚¬ ${caregiver}ëª…`);
          }
          document.getElementById('modalStaff').textContent = staffStrs.join(' / ');
          // êµí†µ/ì£¼ì°¨ ì •ë³´
          document.getElementById('modalTransport').textContent = fac.transport_desc || '-';
          document.getElementById('modalParking').textContent = fac.parking_info || '-';
          // ëª¨ë‹¬ í‘œì‹œ
          document.getElementById('facilityModal').classList.add('active');
          document.getElementById('modalBg').classList.add('active');

          // ì¸ë„¤ì¼ ìš”ì²­
          const kakaoApiKey = 'YOUR_KAKAO_REST_API_KEY'; // ë³¸ì¸ REST API í‚¤ë¡œ êµì²´
          const query = encodeURIComponent(`${fac.admin_name} ${fac.address}`);
          const url = `https://dapi.kakao.com/v2/local/search/keyword.json?query=${query}`;

          fetch(url, {
            headers: { Authorization: `KakaoAK ${kakaoApiKey}` }
          })
            .then(res => res.json())
            .then(async data => {
              if (data.documents && data.documents.length > 0) {
                const place = data.documents[0];
                // í”„ë¡ì‹œ ì„œë²„ë¡œ ì¸ë„¤ì¼ ìš”ì²­
                const proxyUrl = `http://localhost:3001/kakao-thumbnail?placeId=${place.id}`;
                const thumbRes = await fetch(proxyUrl);
                const thumbData = await thumbRes.json();
                if (thumbData.thumbnail) {
                  document.getElementById('kakaoPlaceThumb').src = thumbData.thumbnail;
                  document.getElementById('kakaoPlaceThumb').style.display = 'block';
                }
              }
            });
        }

        // ëª¨ë‹¬ ë‹«ê¸°
        document.getElementById('modalClose').onclick = hideModal;
        document.getElementById('modalBg').onclick = hideModal;
        function hideModal() {
          document.getElementById('facilityModal').classList.remove('active');
          document.getElementById('modalBg').classList.remove('active');
        }

        // ë©”ì¸ ì‹¤í–‰
        let userLoc = null;
        let lastRenderId = 0;
        function startMapWithLocation(loc) {
          userLoc = loc;
          showMap(loc.lat, loc.lng);
          let renderId = ++lastRenderId;
          renderFacilities(loc.lat, loc.lng, currentRadius, currentFilterType).then(() => {
            if (renderId !== lastRenderId) return; // race condition ë°©ì§€
          });
          kakao.maps.event.addListener(map, 'zoom_changed', function() {
            let renderId = ++lastRenderId;
            renderFacilities(userLoc.lat, userLoc.lng, currentRadius, currentFilterType).then(() => {
              if (renderId !== lastRenderId) return;
            });
          });
        }

        function parseWKTPoint(wkt) {
          // ì˜ˆ: "POINT(127.123 37.456)"
          if (!wkt || typeof wkt !== 'string') return null;
          const match = wkt.match(/POINT\\s*\\(([-\\d\\.]+)\\s+([-\\d\\.]+)\\)/);
          if (!match) return null;
          return [parseFloat(match[1]), parseFloat(match[2])]; // [lng, lat]
        }

        const urlParams = new URLSearchParams(window.location.search);
        const facilityId = urlParams.get('id');

        const { data, error } = await supabase
          .from('facilities_with_geojson')
          .select('*')
          .eq('id', facilityId)
          .single();

        if (error || !data) {
          // "ì‹œì„¤ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤" ì•ˆë‚´
        } else {
          // dataë¡œ ìƒì„¸í˜ì´ì§€ ë Œë”ë§
          showFacilityModal(data);
        }

        // --- ê²€ìƒ‰ì°½ ì‹¤ì‹œê°„ í•œê¸€ ì‹œì„¤ëª… ê²€ìƒ‰ ë° íŒì—… êµ¬í˜„ ---
        const searchInput = document.getElementById('searchInput');
        const searchResults = document.getElementById('searchResults');
        let searchTimeout = null;
        searchInput.addEventListener('input', function(e) {
          const keyword = searchInput.value.trim();
          if (searchTimeout) clearTimeout(searchTimeout);
          if (!keyword || !/^[ê°€-í£]+/.test(keyword)) {
            searchResults.style.display = 'none';
            searchResults.innerHTML = '';
            return;
          }
          searchTimeout = setTimeout(async () => {
            // Supabaseì—ì„œ admin_name LIKE ê²€ìƒ‰
            const { data, error } = await supabase
              .from('facilities_with_geojson')
              .select('id, admin_name')
              .ilike('admin_name', `%${keyword}%`)
              .limit(10);
            if (error || !data || data.length === 0) {
              searchResults.innerHTML = '<div style="padding:14px 18px; color:#888;">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
              searchResults.style.display = 'block';
              return;
            }
            searchResults.innerHTML = data.map(fac =>
              `<div class="search-result-item" data-id="${fac.id}" style="padding:12px 18px; cursor:pointer; border-bottom:1px solid #f1f1f1; font-size:1.07em;">${fac.admin_name}</div>`
            ).join('');
            searchResults.style.display = 'block';
          }, 200);
        });
        // ê²€ìƒ‰ ê²°ê³¼ í´ë¦­ ì‹œ ìƒì„¸í˜ì´ì§€ ì´ë™
        searchResults.addEventListener('mousedown', function(e) {
          const item = e.target.closest('.search-result-item');
          if (item) {
            const id = item.getAttribute('data-id');
            window.location.href = `facility-detail.html?id=${encodeURIComponent(id)}`;
          }
        });
        // input ì´ì™¸ í´ë¦­ ì‹œ ê²€ìƒ‰ ê²°ê³¼ ë‹«ê¸°
        document.addEventListener('mousedown', function(e) {
          if (!searchResults.contains(e.target) && e.target !== searchInput) {
            searchResults.style.display = 'none';
          }
        });

        // í•„í„° ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
        document.querySelectorAll('.filter-btn').forEach(btn => {
          btn.addEventListener('click', async function() {
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            currentFilterType = btn.dataset.type;
            console.log('í•„í„° ë²„íŠ¼ í´ë¦­! currentFilterType:', currentFilterType);
            if (userLoc) {
              await renderFacilities(userLoc.lat, userLoc.lng, currentRadius, currentFilterType);
            } else {
              // ìœ„ì¹˜ ì •ë³´ê°€ ì—†ìœ¼ë©´ ì„œìš¸ì‹œì²­ ì¢Œí‘œë¡œ ë§ˆì»¤ ê°±ì‹ 
              await renderFacilities(37.5665, 126.9780, currentRadius, currentFilterType);
            }
          });
        });
        // ìµœì´ˆ ì „ì²´ ì„ íƒ
        document.querySelector('.filter-btn[data-type="all"]').classList.add('selected');

        // DOMì´ ëª¨ë‘ ë Œë”ë§ëœ í›„ ë°”ë¡œ ì‹¤í–‰
        function setupRadiusButtons() {
          const radiusBtns = document.querySelectorAll('.radius-btn');
          function selectRadius(radius) {
            currentRadius = radius;
            radiusBtns.forEach(btn => {
              if (parseInt(btn.dataset.radius) === radius) {
                btn.classList.add('selected');
              } else {
                btn.classList.remove('selected');
              }
            });
            // ì‹œì„¤ ì¬ë Œë”ë§
            if (currentUserLat !== null && currentUserLng !== null) {
              renderFacilities(currentUserLat, currentUserLng, currentRadius, currentFilterType);
            } else {
              alert('ë‚´ ìœ„ì¹˜ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.');
            }
          }
          radiusBtns.forEach(btn => {
            btn.addEventListener('click', function() {
              selectRadius(parseInt(btn.dataset.radius));
            });
          });
          // ìµœì´ˆ 1km ì„ íƒ
          selectRadius(currentRadius);
        }
        setupRadiusButtons();
      });
    });
  </script>
</body>
</html>