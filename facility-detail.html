<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>시설 상세 정보</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <style>
    body {
      margin: 0;
      font-family: 'Noto Sans KR', Arial, sans-serif;
      background: #f8fafc;
      color: #222;
      min-height: 100vh;
    }
    .container {
      max-width: 480px;
      margin: 40px auto;
      background: #fff;
      border-radius: 14px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.07);
      padding: 32px 24px 24px 24px;
    }
    h1 {
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: 18px;
      color: #2563eb;
    }
    .info-row {
      display: flex;
      margin-bottom: 18px;
      align-items: flex-start;
    }
    .info-label {
      width: 110px;
      color: #6b7280;
      font-size: 1.01rem;
      font-weight: 500;
      flex-shrink: 0;
    }
    .info-value {
      flex: 1;
      color: #222;
      font-size: 1.08rem;
      font-weight: 400;
      line-height: 1.6;
    }
    .staff-list {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    .staff-tag {
      background: #e0e7ff;
      color: #2563eb;
      border-radius: 12px;
      padding: 6px 14px;
      font-size: 0.98rem;
      font-weight: 500;
      margin-bottom: 4px;
    }
    .error-message {
      color: #ef4444;
      text-align: center;
      margin: 40px 0;
      font-size: 1.1rem;
      font-weight: 500;
    }
    .loading {
      text-align: center;
      margin: 60px 0 40px 0;
      color: #2563eb;
      font-size: 1.1rem;
      font-weight: 600;
    }
    #blogReviewList .blog-card {
      display: flex; align-items: flex-start; gap: 12px; background: #f8fafc;
      border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.06);
      margin-bottom: 16px; padding: 10px 12px; cursor: pointer; transition: box-shadow 0.15s;
    }
    #blogReviewList .blog-card:hover {
      box-shadow: 0 4px 16px rgba(37,99,235,0.13);
      background: #eef3ff;
    }
    #blogReviewList .blog-thumb {
      width: 64px; height: 64px; border-radius: 7px; object-fit: cover; background: #eee; flex-shrink: 0;
    }
    #blogReviewList .blog-info {
      flex: 1 1 auto; min-width: 0;
    }
    #blogReviewList .blog-title {
      font-weight: 600; color: #2563eb; font-size: 1.04em; margin-bottom: 3px; text-overflow: ellipsis; white-space: nowrap; overflow: hidden;
    }
    #blogReviewList .blog-desc {
      color: #555; font-size: 0.97em; margin-bottom: 2px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
    }
    #blogReviewList .blog-meta {
      font-size: 0.93em; color: #888;
    }
    #blogModalBg {
      position: fixed; left:0; top:0; width:100vw; height:100vh; background:rgba(0,0,0,0.32); z-index:3001; display:none;
    }
    #blogModal {
      position: fixed; left:50%; top:50%; transform:translate(-50%,-50%); width:96vw; max-width:600px; background:#222; border-radius:14px; z-index:3002; display:none; box-shadow:0 4px 32px rgba(0,0,0,0.18); padding-top:36px;
    }
    #blogModal iframe { border-radius:0 0 14px 14px; background:#fff; }
    #blogModalClose { position:absolute; right:18px; top:10px; font-size:2em; color:#fff; z-index:11; cursor:pointer; }
    @media (max-width: 600px) {
      #blogModal { width:100vw; max-width:100vw; }
      #blogModal iframe { width:100vw; }
    }
  </style>
</head>
<body>
  <div id="backBar" style="margin: 24px auto 0 auto; max-width: 480px;">
    <button id="backBtn" style="
      background:none; border:none; color:#2563eb; font-size:1.15rem; font-weight:600; cursor:pointer; display:flex; align-items:center; gap:4px; padding:0;">
      <span style="font-size:1.3em;">&#8592;</span> 뒤로가기
    </button>
  </div>
  <div class="container">
    <div id="loading" class="loading">로딩중...</div>
    <div id="error" class="error-message" style="display:none;"></div>
    <div id="content" style="display:none;">
      <h1 id="facilityName"></h1>
      <div class="info-row">
        <div class="info-label">설립 연차</div>
        <div class="info-value" id="facilityYear"></div>
      </div>
      <div class="info-row">
        <div class="info-label">시설 종류</div>
        <div class="info-value" id="facilityType"></div>
      </div>
      <div class="info-row">
        <div class="info-label">시설 직원</div>
        <div class="info-value staff-list" id="staffList"></div>
      </div>
      <div class="info-row">
        <div class="info-label">교통 정보</div>
        <div class="info-value" id="transportInfo"></div>
      </div>
      <div class="info-row">
        <div class="info-label">주차 정보</div>
        <div class="info-value" id="parkingInfo"></div>
      </div>
    </div>
  </div>
  <div style="text-align:center; margin-top:32px;">
    <a id="callBtn" href="#" style="
      display:inline-block; background:#e74c3c; color:#fff; font-size:1.13rem; font-weight:600;
      border-radius:8px; padding:14px 38px; text-decoration:none; box-shadow:0 2px 8px rgba(0,0,0,0.07);
      transition:background 0.2s; margin-top:8px; letter-spacing:0.5px;"
      >상담 전화 연결</a>
  </div>
  <div id="blogReviewSection" style="margin-top:32px;">
    <h2 style="font-size:1.1em; color:#2563eb;">네이버 블로그 리뷰</h2>
    <div id="blogReviewList" style="font-size:0.98em; color:#444;"></div>
    <div id="blogModalBg" style="display:none;"></div>
    <div id="blogModal" style="display:none;">
      <span id="blogModalClose" style="position:absolute;right:18px;top:10px;font-size:2em;color:#fff;z-index:11;cursor:pointer;">&times;</span>
      <iframe id="blogModalFrame" src="" style="width:100vw;max-width:600px;height:90vh;border:none;z-index:10;display:block;margin:0 auto;background:#fff;"></iframe>
    </div>
  </div>
  <script>
    const supabase = window.supabase.createClient(
      'https://ecryblreqspjhmfpyjdn.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVjcnlibHJlcXNwamhtZnB5amRuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDM5ODgwMTcsImV4cCI6MjA1OTU2NDAxN30.6W-be268DsgQIbgJVk6PBzc-odeRO-cLFOzn7CRkgAw'
    );
    const urlParams = new URLSearchParams(window.location.search);
    const facilityId = urlParams.get('id');
    function showError(msg) {
      document.getElementById('loading').style.display = 'none';
      document.getElementById('content').style.display = 'none';
      const err = document.getElementById('error');
      err.style.display = 'block';
      err.textContent = msg;
    }
    function showContent() {
      document.getElementById('loading').style.display = 'none';
      document.getElementById('error').style.display = 'none';
      document.getElementById('content').style.display = 'block';
    }
    function convertType(code) {
      if (["A01","A02","A03","A04","A05","AAA"].includes(code)) return "노인요양시설";
      if (["B01","C01"].includes(code)) return "방문요양";
      if (["B02","C02"].includes(code)) return "방문목욕";
      if (["B03","C03","B04","C04"].includes(code)) return "주야간보호";
      if (["B05","C05"].includes(code)) return "방문간호";
      if (code === "C06") return "복지용구";
      return code;
    }
    async function loadFacility() {
      if (!facilityId) {
        showError('시설 정보를 찾을 수 없습니다.');
        return;
      }
      // 1. 시설 기본 정보
      const { data: facility, error: facilityError } = await supabase
        .from('facilities')
        .select('*')
        .eq('id', facilityId)
        .single();
      if (facilityError || !facility) {
        showError('시설 정보를 찾을 수 없습니다.');
        return;
      }
      document.getElementById('facilityName').textContent = facility.admin_name || '-';
      // 2. 설립 연차
      let yearStr = '정보없음';
      if (facility.install_date && facility.install_date.length >= 4) {
        const y = facility.install_date.slice(0,4);
        const now = new Date().getFullYear();
        if (!isNaN(parseInt(y))) {
          yearStr = `${y}년 (${now-parseInt(y)+1}년차)`;
        }
      }
      document.getElementById('facilityYear').textContent = yearStr;
      // 3. 시설 종류
      document.getElementById('facilityType').textContent = convertType(facility.admin_type_code);
      // 4. 직원 정보
      const staffList = document.getElementById('staffList');
      staffList.innerHTML = '정보없음';
      console.log('facility.id:', facility.id);
      const { data: staffData, error: staffError } = await supabase
        .from('staff_status')
        .select('*')
        .eq('facility_id', facility.id)
        .order('id', { ascending: false })
        .limit(1)
        .maybeSingle();
      console.log('staffData:', staffData);
      if (!staffError && staffData) {
        let staffArr = [];
        if (parseInt(staffData.social_worker) > 0) staffArr.push(`사회복지사 ${staffData.social_worker}명`);
        const doctor = (parseInt(staffData.doctor_regular)||0) + (parseInt(staffData.doctor_parttime)||0);
        if (doctor > 0) staffArr.push(`의사 ${doctor}명`);
        const nurse = (parseInt(staffData.nurse)||0) + (parseInt(staffData.nurse_aide)||0);
        if (nurse > 0) staffArr.push(`간호사 ${nurse}명`);
        const caregiver = (parseInt(staffData.caregiver_level1)||0) + (parseInt(staffData.caregiver_level2)||0);
        if (caregiver > 0) staffArr.push(`요양보호사 ${caregiver}명`);
        if (staffArr.length > 0) {
          staffList.innerHTML = staffArr.map(s => `<span class='staff-tag'>${s}</span>`).join('');
        }
      }
      // 5. 교통 정보
      document.getElementById('transportInfo').textContent = facility.transport_desc || '정보없음';
      // 6. 주차 정보
      document.getElementById('parkingInfo').textContent = facility.parking_info || '정보없음';
      // 7. 상담 전화 연결 버튼
      const callBtn = document.getElementById('callBtn');
      if (facility.tel && facility.tel.replace(/[^0-9]/g, '').length >= 8) {
        callBtn.href = `tel:${facility.tel.replace(/[^0-9]/g, '')}`;
        callBtn.style.opacity = '1';
        callBtn.style.pointerEvents = 'auto';
      } else {
        callBtn.href = '#';
        callBtn.style.opacity = '0.5';
        callBtn.style.pointerEvents = 'none';
        callBtn.textContent = '전화번호 정보 없음';
      }
      showContent();
      // === 네이버 블로그 리뷰 불러오기 (주소 일부 포함 필터) ===
      await loadNaverBlogReviews(facility.admin_name, facility.address);
    }
    // 네이버 블로그 리뷰 함수 (주소 일부 포함 필터)
    async function loadNaverBlogReviews(facilityName, facilityAddress) {
      try {
        const res = await fetch('http://localhost:3002/naver-blog?query=' + encodeURIComponent(facilityName));
        const data = await res.json();
        const blogList = document.getElementById('blogReviewList');
        if (data.items && data.items.length > 0) {
          // 주소에서 키워드 추출 (도로명, 동/읍/면, 괄호 안 등)
          let keywords = [];
          if (facilityAddress) {
            // 괄호 안(법정동) 추출
            const parenMatch = facilityAddress.match(/\(([^)]+)\)/);
            if (parenMatch) keywords.push(parenMatch[1]);
            // 도로명(예: '금호로13길') 추출
            const roadMatch = facilityAddress.match(/([가-힣A-Za-z0-9]+로[0-9]*길?)/);
            if (roadMatch) keywords.push(roadMatch[1]);
            // 구/동/읍/면/가 등 주요 단어도 추가
            const parts = facilityAddress.split(/\s+/);
            parts.forEach(p => {
              if (p.endsWith('동') || p.endsWith('읍') || p.endsWith('면') || p.endsWith('리') || p.endsWith('가')) {
                keywords.push(p.replace(/[^가-힣0-9]/g, ''));
              }
            });
            // 중복 제거
            keywords = [...new Set(keywords.filter(Boolean))];
          }
          // description에 키워드 중 하나라도 포함되면 통과
          const filtered = data.items.filter(item =>
            item.description && keywords.some(kw => item.description.includes(kw))
          );
          if (filtered.length > 0) {
            blogList.innerHTML = filtered.map((item, idx) => {
              const thumb = item.thumbnail && item.thumbnail.length > 0 ? item.thumbnail : 'https://ssl.pstatic.net/static/blog/img_noimage3.png';
              return `
                <div class="blog-card" data-link="${encodeURIComponent(item.link)}">
                  <img class="blog-thumb" src="${thumb}" alt="썸네일" />
                  <div class="blog-info">
                    <div class="blog-title">${item.title.replace(/<[^>]+>/g, '')}</div>
                    <div class="blog-desc">${item.description.replace(/<[^>]+>/g, '')}</div>
                    <div class="blog-meta">${item.bloggername} · ${item.postdate.replace(/(\d{4})(\d{2})(\d{2})/, '$1-$2-$3')}</div>
                  </div>
                </div>
              `;
            }).join('');
            // 클릭 이벤트(모달 오픈)
            document.querySelectorAll('.blog-card').forEach(card => {
              card.onclick = function() {
                const link = decodeURIComponent(card.getAttribute('data-link'));
                document.getElementById('blogModalFrame').src = link;
                document.getElementById('blogModalBg').style.display = 'block';
                document.getElementById('blogModal').style.display = 'block';
              };
            });
          } else {
            blogList.innerHTML = '<div style="color:#aaa;">해당 시설 주소(일부)가 포함된 블로그 리뷰가 없습니다.</div>';
          }
        } else {
          blogList.innerHTML = '<div style="color:#aaa;">관련 블로그 리뷰가 없습니다.</div>';
        }
      } catch (e) {
        document.getElementById('blogReviewList').innerHTML = '<div style="color:#aaa;">블로그 리뷰를 불러올 수 없습니다.</div>';
      }
    }
    // 블로그 모달 닫기
    document.getElementById('blogModalClose').onclick = hideBlogModal;
    document.getElementById('blogModalBg').onclick = hideBlogModal;
    function hideBlogModal() {
      document.getElementById('blogModal').style.display = 'none';
      document.getElementById('blogModalBg').style.display = 'none';
      document.getElementById('blogModalFrame').src = '';
    }
    loadFacility();
    document.getElementById('backBtn').onclick = function() {
      if (window.history.length > 1) {
        window.history.back();
      } else {
        window.location.href = '/'; // 홈 또는 목록 페이지로 이동
      }
    };
  </script>
</body>
</html> 